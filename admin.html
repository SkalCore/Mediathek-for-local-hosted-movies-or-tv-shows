<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mediathek Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: #0a0a0a;
            color: #fff;
            margin: 0; padding: 0;
            display: flex; height: 100vh; overflow: hidden;
        }

        header {
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(10px);
            width: 280px; height: 100%;
            padding: 30px 20px;
            border-right: 1px solid #222;
            display: flex; flex-direction: column; flex-shrink: 0;
        }

        h1 { margin: 0 0 40px 0; font-size: 1.4rem; color: #e50914; text-transform: uppercase; font-weight: 800; letter-spacing: 1px; border-bottom: 2px solid #333; padding-bottom: 20px; }

        .nav-tabs { display: flex; flex-direction: column; gap: 10px; }
        .tab-btn {
            background: transparent; border: 1px solid transparent;
            color: #888; padding: 14px 16px; cursor: pointer;
            border-radius: 8px; text-align: left; transition: all 0.2s; font-size: 1rem; font-weight: 500;
        }
        .tab-btn:hover { background: #1a1a1a; color: #fff; transform: translateX(5px); }
        .tab-btn.active { background: #e50914; color: white; font-weight: 600; box-shadow: 0 4px 15px rgba(229, 9, 20, 0.3); }

        .nav-footer { margin-top: auto; padding-top: 20px; border-top: 1px solid #333; display: flex; flex-direction: column; gap: 10px; }

        .content-area { flex: 1; overflow: hidden; background: #0f0f0f; display: flex; flex-direction: column; }
        .tab-content { display: none; height: 100%; width: 100%; padding: 40px; overflow-y: auto; }
        .tab-content.active { display: block; }

        .btn-action {
            background: #1a1a1a; color: #ccc; border: 1px solid #333;
            padding: 8px 16px; cursor: pointer; border-radius: 6px;
            font-weight: 500; transition: 0.2s;
        }
        .btn-action:hover { background: #333; color: white; border-color: #555; }

        textarea, input[type="text"] {
            background: #161616; color: #fff; border: 1px solid #333;
            border-radius: 8px; padding: 12px; width: 100%;
            font-family: 'Inter', monospace; transition: 0.3s;
        }
        textarea:focus, input[type="text"]:focus { outline: none; border-color: #e50914; background: #000; }

        .main-container { display: flex; gap: 30px; height: 100%; }
        .csv-column { width: 380px; display: flex; flex-direction: column; gap: 15px; flex-shrink: 0; }
        textarea { resize: none; flex: 1; white-space: pre; line-height: 1.5; font-size: 0.9rem; }

        .manager-column {
            flex: 1; background: #161616; border-radius: 12px; padding: 25px;
            display: flex; flex-direction: column; border: 1px solid #222; overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .list-scroll { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding-right: 5px; margin-top: 15px; }

        .item-row {
            background: #1a1a1a; padding: 15px; border-radius: 8px;
            display: flex; gap: 20px; align-items: center; border: 1px solid #2a2a2a;
            transition: 0.2s;
        }
        .item-row:hover { background: #222; border-color: #444; }

        .ir-img { width: 80px; height: 120px; object-fit: cover; border-radius: 6px; background: #000; box-shadow: 0 4px 8px rgba(0,0,0,0.5); }

        /* Collections */
        .coll-container { display: flex; height: 100%; gap: 30px; }
        .coll-list-col { width: 280px; background: #161616; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; border: 1px solid #222; padding: 15px; }
        .coll-editor-col { flex: 1; background: #161616; border-radius: 12px; padding: 25px; display: flex; flex-direction: column; border: 1px solid #222; overflow: hidden; }
        .coll-item-row { padding: 12px; border-bottom: 1px solid #222; cursor: pointer; border-radius: 6px; transition: 0.2s; }
        .coll-item-row:hover { background: #222; }
        .coll-item-row.active { background: #222; color: #e50914; font-weight: bold; border-left: 3px solid #e50914; }

        .ce-split-view { display: flex; flex: 1; gap: 30px; overflow: hidden; margin-top: 20px; }
        .ce-movies-grid { flex: 1; overflow-y: auto; display: flex; flex-wrap: wrap; gap: 15px; align-content: flex-start; }
        .ce-movie-card { width: 90px; position: relative; background: #000; border-radius: 4px; overflow: hidden; transition: 0.2s; }
        .ce-movie-card:hover { transform: scale(1.05); }
        .ce-movie-card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; }
        .ce-remove { position: absolute; top: 0; right: 0; background: rgba(229, 9, 20, 0.9); color: white; cursor: pointer; width: 25px; text-align: center; }

        .ac-row { display: flex; justify-content: space-between; padding: 15px; background: #1a1a1a; margin-bottom: 8px; border-radius: 8px; align-items: center; border: 1px solid #2a2a2a; }
        .ac-row.hidden { opacity: 0.5; background: #111; border: 1px dashed #333; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 2000; justify-content: center; align-items: center; }
        .console-modal { width: 900px; height: 600px; background: #111; border: 1px solid #333; display: flex; flex-direction: column; border-radius: 12px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.8); }
        .console-box { flex: 1; background: #0a0a0a; color: #46d369; font-family: 'Consolas', monospace; padding: 25px; overflow-y: auto; white-space: pre-wrap; font-size: 0.9rem; }

        .edit-content { background: #1a1a1a; padding: 30px; width: 500px; border: 1px solid #333; border-radius: 12px; display: flex; flex-direction: column; gap: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.8); }
        .upload-wrapper { display: flex; gap: 10px; }

        .pagination-bar { display: flex; justify-content: center; gap: 12px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #333; }
        .pag-btn { background: #222; color: #aaa; padding: 10px 20px; cursor: pointer; border: 1px solid #333; border-radius: 6px; font-weight: 600; transition: 0.2s; }
        .pag-btn:hover { background: #e50914; border-color: #e50914; color: white; }

        #dbStatus { font-size: 0.85rem; padding: 8px; background: rgba(255,255,255,0.05); margin-top: 15px; border-radius: 6px; text-align: center; border: 1px solid #333; color: #888; }
        #dbStatus.error { background: rgba(128, 0, 0, 0.3); color: #ff5555; border-color: #800; }
        #toast { position: fixed; bottom: 30px; right: 30px; background: #46d369; color: black; padding: 15px 30px; border-radius: 8px; font-weight: bold; display: none; z-index: 3000; box-shadow: 0 10px 30px rgba(0,0,0,0.5); font-size: 1.1rem; }

        .dynamic-gen-btn {
            background: #e50914; color: white; font-weight: bold;
            border: none; padding: 10px 20px;
            cursor: pointer; border-radius: 6px; display: none;
            animation: pulse 2s infinite;
            box-shadow: 0 4px 15px rgba(229, 9, 20, 0.4);
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>
    <header>
        <h1>Mediathek Admin</h1>
        <div class="nav-tabs">
            <button class="tab-btn active" onclick="showTab('csv')">1. Manager & CSV</button>
            <button class="tab-btn" onclick="showTab('fix')">2. Korrektur Center</button>
            <button class="tab-btn" onclick="showTab('colls')">3. Eigene Kollektionen</button>
            <button class="tab-btn" onclick="showTab('auto')">4. Auto-Kollektionen</button>
        </div>
        <div id="dbStatus">DB Status: Pr√ºfe...</div>
        <div class="nav-footer">
            <button class="tab-btn" onclick="window.location.href='/'">‚Üê Zur Startseite</button>
            <button class="tab-btn" onclick="doLogout()" style="color: #e50914;">Abmelden</button>
        </div>
    </header>

    <input type="file" id="fileInput" style="display:none;" accept="image/*">
    <div id="toast">Gespeichert!</div>
    <div id="console" class="modal-overlay"><div class="console-modal"><div style="padding:15px; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center; background:#1a1a1a;"><h3>Status</h3><button class="btn-action" id="consoleCloseBtn" style="background:#e50914; color:white; border:none; display:none;" onclick="closeConsole()">Fertig - Schlie√üen</button></div><div id="consoleOutput" class="console-box"></div></div></div>
    <div id="editModal" class="modal-overlay"><div class="edit-content"><h3>Bearbeiten</h3><div>Poster:<div class="upload-wrapper"><input type="text" id="editPoster"><button class="btn-action" onclick="triggerUpload('editPoster')">Upload</button></div></div><div>Trailer ID/URL:<input type="text" id="editTrailer"></div><div style="display:flex; justify-content:flex-end; gap:10px;"><button class="btn-action" onclick="closeEditModal()">Abbrechen</button><button class="btn-action" style="background:#46d369; color:black; border:none;" onclick="saveEditOverride()">Speichern</button></div></div></div>

    <div class="content-area">
        <div id="tab-csv" class="tab-content active">
            <div class="main-container">
                <div class="csv-column"><h3>Filme (CSV)</h3><textarea id="csvMovies"></textarea><div style="display:flex; gap:10px; margin-bottom:20px;"><button class="btn-action" style="flex:1" onclick="saveCSV('movie')">Speichern</button><button class="btn-action" style="flex:1; background:#e50914; color:white; border:none;" onclick="runBatch('movie')">Generieren</button></div><h3>Serien (CSV)</h3><textarea id="csvSeries"></textarea><div style="display:flex; gap:10px;"><button class="btn-action" style="flex:1" onclick="saveCSV('series')">Speichern</button><button class="btn-action" style="flex:1; background:#e50914; color:white; border:none;" onclick="runBatch('series')">Generieren</button></div></div>
                <div class="manager-column"><h3>Fehlende Eintr√§ge</h3>
                    <div style="color:#888; font-size:0.9rem; margin-bottom:15px;">Zeigt Eintr√§ge, die NICHT in der Datenbank gefunden wurden.</div>
                    <div id="dynamicGenMissing" style="margin-bottom:15px; display:none;">
                         <button class="dynamic-gen-btn" style="width:100%" onclick="runBatch(currentType)">‚ö†Ô∏è √Ñnderungen anwenden (Generieren)</button>
                    </div>
                    <div style="margin-bottom:15px;"><button class="btn-action" onclick="initLoadMissing('movie')">Filme laden</button> <button class="btn-action" onclick="initLoadMissing('series')">Serien laden</button></div>
                    <div id="missingList" class="list-scroll"></div>
                </div>
            </div>
        </div>
        <div id="tab-fix" class="tab-content">
            <div class="manager-column" style="height:100%">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3>Zugewiesene Eintr√§ge bearbeiten</h3>
                    <button id="dynamicGenFix" class="dynamic-gen-btn" onclick="runBatch(currentType)">‚ö†Ô∏è Jetzt Generieren</button>
                </div>

                <div class="fix-controls">
                    <button class="btn-action" onclick="initLoadAssigned('movie')">Filme laden</button>
                    <button class="btn-action" onclick="initLoadAssigned('series')">Serien laden</button>
                </div>

                <div class="fix-controls" style="border-top:1px solid #333; padding-top:15px; margin-top:15px;">
                    <input type="text" id="fixSearch" placeholder="Suche in Datenbank..." oninput="renderFixList()" style="width:100%; padding:14px;">
                </div>

                <div id="assignedList" class="list-scroll"></div>

                <div class="pagination-bar">
                    <button class="pag-btn" onclick="changeFixPage(-1)">‚Üê Zur√ºck</button>
                    <span id="fixPageInfo" style="padding:5px 15px; font-weight:bold; align-self:center; color:#ccc;">Seite 1</span>
                    <button class="pag-btn" onclick="changeFixPage(1)">Vor ‚Üí</button>
                </div>
            </div>
        </div>
        <div id="tab-colls" class="tab-content">
            <div class="coll-container">
                <div class="coll-list-col"><button class="btn-action" style="width:100%; margin-bottom:15px; background:#e50914; color:white; border:none;" onclick="createNewColl()">+ Neue Kollektion</button><div id="collList" style="flex:1; overflow-y:auto;"></div></div>
                <div class="coll-editor-col" id="collEditor" style="display:none;">
                    <div style="display:flex; gap:10px; border-bottom:1px solid #333; padding-bottom:15px;"><input type="text" id="ceName" placeholder="Name"><div class="upload-wrapper"><input type="text" id="cePoster" placeholder="Poster URL"><button class="btn-action" onclick="triggerUpload('cePoster')">Up</button></div><button class="btn-action" onclick="saveCurrentColl()">Save</button><button class="btn-action" style="background:#800; color:white; border:none;" onclick="deleteCurrentColl()">Del</button></div>
                    <div class="ce-split-view"><div style="flex:1; border-right:1px solid #333; padding-right:15px;"><h4>Inhalt</h4><div id="ceMovies" class="ce-movies-grid"></div></div><div style="flex:1; padding-left:15px;"><h4>Hinzuf√ºgen</h4><input type="text" id="ceSearchInput" oninput="localSearchColl()" placeholder="Suche..." style="margin-bottom:10px;"><div id="ceLocalResults" class="list-scroll" style="height:300px;"></div></div></div>
                </div>
            </div>
        </div>
        <div id="tab-auto" class="tab-content">
            <div class="manager-column" style="height:100%; max-width: 1000px; margin: 0 auto;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3>Automatische Kollektionen</h3>
                    <div style="display:flex; gap:10px">
                        <button class="btn-action" onclick="loadAutoColls(true)">‚Üª Daten neu laden</button>
                        <button class="btn-action" onclick="saveAutoSettings()" style="background:#46d369; color:black; border:none;">Speichern & Generieren</button>
                    </div>
                </div>
                <div id="autoCollList" class="list-scroll"></div>
            </div>
        </div>
    </div>

    <script>
        window.dbMovies = []; window.dbSeries = [];
        document.getElementById('csvMovies').value = localStorage.getItem('admin_csv_movies') || "";
        document.getElementById('csvSeries').value = localStorage.getItem('admin_csv_series') || "";
        let currentType='movie', mediaOverrides={}, allCollections=[], activeCollIndex=-1, autoSettings={hidden:[],renamed:{},posters:{}}, uploadTargetInputId=null;

        let fixListCache = []; let fixPage = 1; const fixPerPage = 50;

        async function doLogout(){ await fetch('/api/logout'); window.location.href='/index.html'; }

        function showNeedsGenerate() {
            document.getElementById('dynamicGenFix').style.display = 'block';
            document.getElementById('dynamicGenMissing').style.display = 'block';
            const t=document.getElementById('toast');
            t.innerText = "Gespeichert! Bitte Generieren.";
            t.style.display='block';
            setTimeout(()=>t.style.display='none', 4000);
        }
        function hideNeedsGenerate() {
            document.getElementById('dynamicGenFix').style.display = 'none';
            document.getElementById('dynamicGenMissing').style.display = 'none';
        }

        async function refreshDB() {
            const st = document.getElementById('dbStatus'); st.innerText = "Lade DB..."; st.className = '';
            try {
                const ts = Date.now();
                window.dbMovies = await(await fetch(`/api/get-db?type=movie&t=${ts}`)).json();
                window.dbSeries = await(await fetch(`/api/get-db?type=series&t=${ts}`)).json();
                if(!window.dbMovies || !Array.isArray(window.dbMovies)) window.dbMovies = [];
                if(!window.dbSeries || !Array.isArray(window.dbSeries)) window.dbSeries = [];
                st.innerText = `DB OK: ${window.dbMovies.length} Filme / ${window.dbSeries.length} Serien`;
            } catch(e) { st.innerText = "Fehler!"; st.className = 'error'; window.dbMovies = []; window.dbSeries = []; }
        }
        refreshDB();

        function showTab(id){ document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active')); document.getElementById(`tab-${id}`).classList.add('active'); event.target.classList.add('active'); if(id==='colls')loadCollections(); if(id==='auto')loadAutoColls(); }

        function saveCSV(type,s=false){ localStorage.setItem(type==='movie'?'admin_csv_movies':'admin_csv_series', document.getElementById(type==='movie'?'csvMovies':'csvSeries').value); if(!s)alert("Gespeichert"); }

        async function runBatch(type){
            hideNeedsGenerate();
            saveCSV(type,true); const o=document.getElementById('consoleOutput'); document.getElementById('console').style.display='flex'; document.getElementById('consoleCloseBtn').style.display='none'; o.innerHTML="üöÄ Start...\n"; try{ const r=await fetch(`/api/generate/${type==='movie'?'movies':'series'}`,{method:'POST',body:document.getElementById(type==='movie'?'csvMovies':'csvSeries').value}); const rd=r.body.getReader(); const dec=new TextDecoder(); while(true){ const {done,value}=await rd.read(); if(done)break; const t=dec.decode(value,{stream:true}); t.split('\n').forEach(l=>{ if(l.startsWith('LOG:'))o.innerHTML+=`<div>${l.substring(4)}</div>`; }); o.scrollTop=o.scrollHeight; } o.innerHTML+="\n‚úÖ FERTIG!"; document.getElementById('consoleCloseBtn').style.display='block'; o.scrollTop=o.scrollHeight; }catch(e){o.innerHTML+=`\n‚ùå ${e}`; document.getElementById('consoleCloseBtn').style.display='block';}
        }

        function closeConsole(){ document.getElementById('console').style.display='none'; refreshDB().then(()=>{ if(document.getElementById('tab-auto').classList.contains('active')) loadAutoColls(true); }); }
        async function loadOverrides(){ try{ mediaOverrides=await(await fetch('/api/media-overrides')).json(); }catch{mediaOverrides={};} }

        function initLoadAssigned(t){
            currentType=t; loadOverrides();
            const db=t==='movie'?window.dbMovies:window.dbSeries;
            const csvLines = document.getElementById(t==='movie'?'csvMovies':'csvSeries').value.split('\n');
            fixListCache = [];
            csvLines.forEach((l,i)=>{
                if(!l.trim())return; const p=l.split(';'); const csvName = p[0].trim();
                let csvId = null; if(p.length > 1) { const lastPart = p[p.length-1].trim(); if(/^\d+$/.test(lastPart)) csvId = parseInt(lastPart); }
                if(csvId === 0) return;
                let m = db.find(x => x.searchQuery === csvName);
                if(!m && csvId) { m = db.find(x => x.id == csvId); }
                if(m && !m.isOffline){
                    fixListCache.push({ lineIdx: i, csvName: csvName, dbTitle: m.title, poster: m.poster, id: m.id });
                }
            });
            fixPage = 1; renderFixList();
        }
        function renderFixList(){
            const container = document.getElementById('assignedList'); container.innerHTML = '';
            const q = document.getElementById('fixSearch').value.toLowerCase();
            const filtered = fixListCache.filter(item => item.csvName.toLowerCase().includes(q) || item.dbTitle.toLowerCase().includes(q));
            const totalPages = Math.ceil(filtered.length / fixPerPage) || 1;
            if(fixPage > totalPages) fixPage = totalPages; if(fixPage < 1) fixPage = 1;

            document.getElementById('fixPageInfo').innerText = `Seite ${fixPage} von ${totalPages}`;

            const start = (fixPage - 1) * fixPerPage;
            const items = filtered.slice(start, start + fixPerPage);
            items.forEach(item => {
                const div=document.createElement('div'); div.className='item-row';
                div.innerHTML=`<img src="${item.poster||''}" class="ir-img"><div style="flex:1"><b style="color:#e50914; font-size:1.1rem;">${item.csvName}</b><br><small style="color:#aaa;">${item.dbTitle}</small></div><button class="btn-action" onclick="openEditModal('${item.id}')">Edit</button><button class="btn-action" style="background:#800; color:white; border:none;" onclick="unlink(${item.lineIdx})">X</button>`;
                container.appendChild(div);
            });
        }
        function changeFixPage(d){ fixPage+=d; renderFixList(); }

        function unlink(i){
            const el=document.getElementById(currentType==='movie'?'csvMovies':'csvSeries');
            const l=el.value.split('\n');
            const nameOnly = l[i].split(';')[0].trim();
            l[i] = nameOnly + ';0';
            el.value=l.join('\n');
            saveCSV(currentType,true);
            initLoadAssigned(currentType);
            showNeedsGenerate();
        }

        let currentEditId=null; function openEditModal(id){ currentEditId=id; document.getElementById('editModal').style.display='flex'; document.getElementById('editPoster').value=mediaOverrides[id]?.poster||''; document.getElementById('editTrailer').value=mediaOverrides[id]?.trailer||''; }
        function closeEditModal(){ document.getElementById('editModal').style.display='none'; }
        async function saveEditOverride(){ if(!mediaOverrides[currentEditId])mediaOverrides[currentEditId]={}; mediaOverrides[currentEditId].poster=document.getElementById('editPoster').value; mediaOverrides[currentEditId].trailer=document.getElementById('editTrailer').value; await fetch('/api/media-overrides',{method:'POST',body:JSON.stringify(mediaOverrides)}); closeEditModal(); alert('Gespeichert.'); }

        function initLoadMissing(t){
            currentType=t; const db=t==='movie'?window.dbMovies:window.dbSeries;
            const list=document.getElementById('missingList'); list.innerHTML='';

            document.getElementById(t==='movie'?'csvMovies':'csvSeries').value.split('\n').forEach((l,i)=>{
                if(!l.trim()) return;
                const p = l.split(';');
                const csvName = p[0].trim();
                let csvId = null;
                let isZero = false;

                if(p.length > 1) {
                    const lastPart = p[p.length-1].trim();
                    if(/^\d+$/.test(lastPart)) {
                        csvId = parseInt(lastPart);
                        if(csvId === 0) isZero = true;
                    }
                }

                let found = db.find(x => x.searchQuery === csvName);
                if(!found || found.isOffline || isZero){
                    const div=document.createElement('div'); div.style='padding:15px; background:#1a1a1a; border-radius:8px; border:1px solid #333; margin-bottom:10px;';
                    const label = (isZero || (found && found.isOffline)) ? '<span style="color:#e50914; font-weight:bold;">[MANUELL]</span> ' : '';

                    div.innerHTML=`${label}<b style="font-size:1.05rem;">${l}</b> (Z. ${i+1}) <div style="display:flex; gap:10px; margin-top:10px;"><input type="text" id="in-${i}" placeholder="Suchen..." onkeydown="if(event.key==='Enter') doSearch(${i})" style="padding:8px;"><button class="btn-action" onclick="doSearch(${i})">üîç</button></div>
                    <div id="res-${i}" style="display:grid; grid-template-columns: repeat(auto-fill, 110px); gap:15px; margin-top:15px;"></div>`;
                    list.appendChild(div);
                }
            });
        }

        async function doSearch(i){
            const q=document.getElementById(`in-${i}`).value||document.getElementById(currentType==='movie'?'csvMovies':'csvSeries').value.split('\n')[i].split(';')[0].trim();
            const r=document.getElementById(`res-${i}`); r.innerHTML='...';
            const res=await(await fetch(`/api/manual-search?q=${encodeURIComponent(q)}&type=${currentType}`)).json();
            r.innerHTML='';
            res.forEach(m=>{
                const d=document.createElement('img'); d.src=m.poster;
                d.style='width:110px; height:165px; object-fit:cover; cursor:pointer; border-radius:6px; border:1px solid #444; transition:0.2s;';
                d.onmouseover=function(){this.style.transform='scale(1.1)';this.style.zIndex='10';};
                d.onmouseout=function(){this.style.transform='scale(1)';this.style.zIndex='1';};
                d.title=m.title;
                d.onclick=()=>{
                    const el=document.getElementById(currentType==='movie'?'csvMovies':'csvSeries');
                    const lines=el.value.split('\n');
                    lines[i]=`${lines[i].split(';')[0].trim()};${m.id}`;
                    el.value=lines.join('\n');
                    saveCSV(currentType,true);
                    const rowDiv = r.parentElement; rowDiv.style.opacity = '0.3'; rowDiv.innerHTML = '<div style="color:#46d369; font-weight:bold; padding:10px;">Zugeordnet!</div>';
                    showNeedsGenerate();
                };
                r.appendChild(d);
            });
        }

        async function loadCollections(){ try{ allCollections=await(await fetch('/api/custom-collections')).json(); }catch{allCollections=[];} renderCollList(); document.getElementById('collEditor').style.display='none'; }
        function renderCollList(){ const l=document.getElementById('collList'); l.innerHTML=''; allCollections.forEach((c,i)=>{ const d=document.createElement('div'); d.className=`coll-item-row ${i===activeCollIndex?'active':''}`; d.innerText=c.name; d.onclick=()=>openColl(i); l.appendChild(d); }); }
        function createNewColl(){ allCollections.push({id:'c_'+Date.now(),name:'Neu',poster:'',movieIds:[]}); openColl(allCollections.length-1); saveCollections(); }
        function openColl(i){ activeCollIndex=i; document.getElementById('collEditor').style.display='flex'; document.getElementById('ceName').value=allCollections[i].name; document.getElementById('cePoster').value=allCollections[i].poster; renderCollMovies(); }
        function renderCollMovies(){ const c=document.getElementById('ceMovies'); c.innerHTML=''; const co=allCollections[activeCollIndex]; co.movieIds.forEach(uid=>{ const m=window.dbMovies.find(x=>x.uid==uid||x.id==uid); if(!m)return; const d=document.createElement('div'); d.className='ce-movie-card'; d.innerHTML=`<img src="${m.poster}" title="${m.searchQuery}"><div class="ce-remove" onclick="remMov('${uid}')">x</div>`; c.appendChild(d); }); }
        function localSearchColl(){ const q=document.getElementById('ceSearchInput').value.toLowerCase(); const r=document.getElementById('ceLocalResults'); r.innerHTML=''; if(!q)return; window.dbMovies.filter(m=>(m.searchQuery||m.title).toLowerCase().includes(q)).slice(0,10).forEach(m=>{ const d=document.createElement('div'); d.style='cursor:pointer; padding:5px; border-bottom:1px solid #333;'; d.innerText=m.searchQuery||m.title; d.onclick=()=>{ allCollections[activeCollIndex].movieIds.push(m.uid); saveCollections(); renderCollMovies(); }; r.appendChild(d); }); }
        function remMov(uid){ const idx=allCollections[activeCollIndex].movieIds.indexOf(uid); if(idx>-1)allCollections[activeCollIndex].movieIds.splice(idx,1); saveCollections(); renderCollMovies(); }
        function saveCurrentColl(){ allCollections[activeCollIndex].name=document.getElementById('ceName').value; allCollections[activeCollIndex].poster=document.getElementById('cePoster').value; saveCollections(); renderCollList(); }
        function deleteCurrentColl(){ allCollections.splice(activeCollIndex,1); document.getElementById('collEditor').style.display='none'; saveCollections(); renderCollList(); }
        async function saveCollections(){ await fetch('/api/custom-collections',{method:'POST',body:JSON.stringify(allCollections)}); }

        async function loadAutoColls(force=false){
            const l=document.getElementById('autoCollList');
            l.innerHTML='<div style="padding:20px; color:#aaa">Lade Daten...</div>';
            if(force || !window.dbMovies || window.dbMovies.length === 0) { await refreshDB(); }
            if(!window.dbMovies || window.dbMovies.length === 0) { l.innerHTML = '<div style="padding:20px; color:#aaa">Keine Filme gefunden.</div>'; return; }
            try { autoSettings = await(await fetch('/api/auto-coll-settings')).json(); } catch { autoSettings = {}; }
            if(!autoSettings) autoSettings = {}; if(!autoSettings.hidden || !Array.isArray(autoSettings.hidden)) autoSettings.hidden = []; if(!autoSettings.renamed) autoSettings.renamed = {}; if(!autoSettings.posters) autoSettings.posters = {};
            l.innerHTML = '';
            const colls={};
            window.dbMovies.forEach(m=>{ const c = m.originalCollection || m.collection; if(c){ if(!colls[c.id])colls[c.id]={...c, count:0}; colls[c.id].count++; } });
            Object.values(colls).forEach(c=>{
                const h = autoSettings.hidden.map(String).includes(String(c.id));
                const d=document.createElement('div'); d.className=`ac-row ${h?'hidden':''}`;
                d.innerHTML=`<div><b>${c.name}</b> (${c.count})</div><div class="ac-controls"><input type="text" class="ac-input" placeholder="Name" value="${autoSettings.renamed[c.id]||''}" onchange="updAuto('renamed',${c.id},this.value)"><input type="text" class="ac-input" placeholder="Poster" value="${autoSettings.posters[c.id]||''}" onchange="updAuto('posters',${c.id},this.value)"><button class="btn-action" onclick="togAuto(${c.id})">${h?'Show':'Hide'}</button></div>`;
                l.appendChild(d);
            });
            if(Object.keys(colls).length === 0) l.innerHTML = '<div style="padding:20px; color:#aaa">Keine Auto-Kollektionen in den Filmen gefunden.</div>';
        }

        function togAuto(id){ id = parseInt(id); const i=autoSettings.hidden.indexOf(id); if(i>-1) autoSettings.hidden.splice(i,1); else autoSettings.hidden.push(id); saveAutoSettings().then(() => loadAutoColls(false)); }
        function updAuto(k,id,v){ if(!v)delete autoSettings[k][id]; else autoSettings[k][id]=v; }
        async function saveAutoSettings(){ await fetch('/api/auto-coll-settings',{method:'POST',body:JSON.stringify(autoSettings)}); runBatch('movie'); }

        function triggerUpload(targetId){ uploadTargetInputId=targetId; document.getElementById('fileInput').click(); }
        document.getElementById('fileInput').onchange=async function(){ if(this.files[0]){ const r=new FileReader(); r.onload=async(e)=>{ const res=await(await fetch('/api/upload',{method:'POST',body:JSON.stringify({image:e.target.result,name:this.files[0].name})})).json(); if(res.url)document.getElementById(uploadTargetInputId).value=res.url; const autoId=this.getAttribute('data-auto-id'); if(autoId) updAuto('posters', autoId, res.url); }; r.readAsDataURL(this.files[0]); } };
    </script>
</body>
</html>
